// memset seen at: http://stackoverflow.com/questions/632846/clearing-a-char-array-c
#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>

// Flags
int r = 0;
int j = 0;
int s = 0;
int w = 0;

int line_width = 72;

void help() {
    printf("Usage: ./format <optional flags> \n\
            Flags:\n\
            \t -w # \t : Change the max. line (w)idth (specify a number between 1 - 1000).\n\
            \t -r \t : (R)ight-align text. \n\
            \t -j \t : (J)ustify-align text. \n\
            \t -s \t : (S)kip multiple blank lines.\n");
    exit(1);
}


void check_args(int argc, char *argv[]) {
    for (int i = 1; i < argc; i++) {
        if (strcmp("-w", argv[i]) == 0) {
            if (i < (argc - 1)) {
                if (isdigit(*argv[i + 1])) {
                    line_width = atoi(argv[++i]);
                    if (line_width < 1 || line_width > 1000) {
                        help();
                    }
                } else {
                    help();
                }
            } else {
                help();
            }
        } else if ((strcmp("-r", argv[i]) == 0)) {
            if (j == 0) {
                r = 1;
            } else {
                printf("Whoops, you can't have right alignment turned on too!\n");
                help();
            }
        } else if (strcmp("-j", argv[i]) == 0) {
            if (r == 0) {
                j = 1;
            } else {
                printf("Whoops, you can't have justified alignment turned on too!\n");
                help();
            }
        } else if (strcmp("-s", argv[i]) == 0) {
            s = 1;
        } else {
            help();
        }
    }
}

void print_lines() {
    char word[100];
    char line[1000];
    char c = 0;
    int line_l = 0;
    int word_l = 0;

    c = fscanf(stdin, "%s" , word);
    while (c != EOF) {
        word_l = strlen(word);
        if ((line_l + word_l) <= line_width) {
            strcat(line, strcat(word, " "));
            line_l += word_l + 1;
            printf("%s", word);
        } else {
            if (0 != r) {
                do {
                    printf("\r");
                } while (0 == r);
                int spaces = line_width - line_l;
                for (int i = 0; i <= spaces; i++) {
                    printf(" ");
                }
                printf("%s", line);
            }
            memset(line, 0, sizeof(char));
            strcat(line, strcat(word, " "));
            line_l = word_l + 1;
            printf("\n%s", word);
        }

        int ch = getchar();
        int nextch = 0;

        while(ch == '\n') {
            if ((nextch= getchar()) == '\n') {
                if (0 != r) {
                    do {
                        printf("\r");
                    } while (0 == r);
                    int spaces = line_width - line_l;
                    for (int i = 0; i <= spaces; i++) {
                        printf(" ");
                    }
                    printf("%s", line);
                }
                printf("\n\n");
                ch = getchar();
                while(ch == '\n') {
                    if (s != 1) {
                        printf("%c", ch);
                    }
                    ch = getchar();
                }
                memset(line, 0, sizeof(char));
                line_l= 0;
            }
            ch = getchar();
        }
        ungetc(ch, stdin);
        c = fscanf(stdin, "%s" , word);
    }
    if (0 != r) {
        do {
            printf("\r");
        } while (0 == r);
        int spaces = line_width - line_l;
        for (int i = 0; i <= spaces; i++) {
            printf(" ");
        }
        printf("%s", line);
    }
}

int main(int argc, char *argv[]) {
    check_args(argc, argv);
    print_lines();
    return 0;
}
